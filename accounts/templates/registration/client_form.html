{% extends 'base.html' %}
{% block navbar %}
    {% include 'client_navbar.html' %}
{% endblock %}
{% block content %}
<style>
  .form-step {
    display: none;
    transition: all 0.3s ease;
  }
  
  .form-step.active {
    display: block;
    animation: fadeIn 0.5s;
  }
  
  .shadow-wrap {
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    background-color: white;
  }
  
  .form-wrap {
    position: relative;
  }
  
  .question-wrap {
    margin-bottom: 1.5rem;
  }
  
  .form-wrap h2 {
    margin-bottom: 2rem;
    text-align: center;
    color: #333;
  }
  
  .step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 1.5rem;
  }
  
  .step-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #ddd;
    margin: 0 5px;
    transition: background-color 0.3s ease;
  }
  
  .step-dot.active {
    background-color: #007bff;
  }
  
  .step-progress {
    height: 5px;
    background-color: #eee;
    margin-bottom: 2rem;
    border-radius: 3px;
    overflow: hidden;
  }
  
  .progress-bar {
    height: 100%;
    background-color: #007bff;
    width: 0%;
    transition: width 0.3s ease;
  }
  
  .question-label {
    font-size: 1.2rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #333;
  }
  
  .error-message {
    color: #dc3545;
    font-size: 0.85rem;
    margin-top: 0.5rem;
    display: none;
  }
  
  .btn-container {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
  }
  
  .btn-primary {
    background-color: #007bff;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  
  .btn-primary:hover {
    background-color: #0069d9;
  }
  
  .btn-back {
    background-color: #6c757d;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  
  .btn-back:hover {
    background-color: #5a6268;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* For checkbox and multi-select fields */
  .checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 1rem;
  }
  
  .checkbox-item {
    display: flex;
    align-items: center;
  }
  
  .checkbox-item input {
    margin-right: 8px;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-dialog {
    background-color: white;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 15px;
}

.modal-body {
    padding: 20px 0;
}

.languages-section, .skills-section {
    margin-bottom: 20px;
}

.error-message {
    color: red;
    margin-top: 10px;
}

.modal-footer {
    display: flex;
    justify-content: space-between;
    border-top: 1px solid #e9ecef;
    padding-top: 15px;
}
</style>


{% load static %}
<div class="container mt-5 mb-5">
  <div class="shadow-wrap">
    <div class="form-wrap">
      <h2>Client Registration</h2>
      
      <div class="step-progress">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      
      <div class="step-indicator" id="step-indicator">
        <!-- Step dots will be generated by JavaScript -->
      </div>
      
      <form method="post" enctype="multipart/form-data" id="step-form" novalidate>
        {% csrf_token %}
        
        <!-- Hidden container for original fields -->
        <div id="original-fields" style="display: none;">
          {{ form.as_p }}
        </div>
        
        <!-- Container for dynamically generated multi-step fields -->
        <div id="form-steps-container"></div>
        
        <!-- Final Language and Skills Selection Popup -->
        <div id="final-selection-modal" class="modal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Final Step: Language & Skills</h5>
              </div>
              <div class="modal-body">
                <div class="languages-section">
                  <h6>Select Languages*</h6>
                  <div id="languages-container">
                    {{ form.languages }}
                  </div>
                </div>
                <div class="error-message" id="final-selection-error"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-modal">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submit-final-form">Submit</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Navigation Buttons -->
        <div class="btn-container">
          <button type="button" id="prev-btn" class="btn-back" style="display: none;">Previous</button>
          <button type="button" id="next-btn" class="btn-primary">Next</button>
          <button type="button" id="final-step-btn" class="btn-primary" style="display: none;">Complete Registration</button>
        </div>
      </form>      
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('step-form');
    const originalFieldsContainer = document.getElementById('original-fields');
    
    if (!originalFieldsContainer) {
        console.error("Original fields container (#original-fields) not found.");
        return;
    }
    
    // Query for form fields inside the hidden container
    const originalFields = Array.from(originalFieldsContainer.querySelectorAll('p'));
    if (originalFields.length === 0) {
        console.error("No form fields found in the original-fields container.");
        return;
    }
    
    const formStepsContainer = document.getElementById('form-steps-container');
    const stepIndicator = document.getElementById('step-indicator');
    const progressBar = document.getElementById('progress-bar');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const finalStepBtn = document.getElementById('final-step-btn');
    
    // Modal elements
    const finalSelectionModal = document.getElementById('final-selection-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const submitFinalFormBtn = document.getElementById('submit-final-form');
    const finalSelectionError = document.getElementById('final-selection-error');

    let currentStep = 0;
    let steps = [];

    // Process each original field and create a form step
    originalFields.forEach(field => {
        const labelElement = field.querySelector('label');
        const inputElement = field.querySelector('input, select, textarea');

        const checkboxes = field.querySelectorAll('input[type="checkbox"]');
        const isCheckboxGroup = checkboxes.length > 1;

        // Skip hidden fields and CSRF token
        if ((!inputElement && !isCheckboxGroup) || (inputElement && inputElement.type === 'hidden')) return;

        const stepElement = document.createElement('div');
        stepElement.className = 'form-step';

        // Determine the label text
        let labelText = '';
        if (labelElement) {
            labelText = labelElement.textContent.trim();
        } else if (inputElement && inputElement.placeholder) {
            labelText = inputElement.placeholder;
        } else if (inputElement) {
            labelText = inputElement.name.replace(/_/g, ' ');
        } else if (isCheckboxGroup && checkboxes[0]) {
            const name = checkboxes[0].name.replace(/\[\]/g, '');
            labelText = name.replace(/_/g, ' ').replace(/^./, str => str.toUpperCase());
        }

        if (isCheckboxGroup) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-wrap';
            
            const questionLabel = document.createElement('div');
            questionLabel.className = 'question-label';
            questionLabel.textContent = labelText;
            questionDiv.appendChild(questionLabel);
            
            const checkboxGroup = document.createElement('div');
            checkboxGroup.className = 'checkbox-group';
            
            checkboxes.forEach((checkbox, index) => {
                const checkItem = document.createElement('div');
                checkItem.className = 'checkbox-item';
                
                const clonedCheckbox = checkbox.cloneNode(true);
                clonedCheckbox.id = `cloned_${checkbox.id || 'checkbox_' + index}`;
                
                checkItem.appendChild(clonedCheckbox);
                
                // Try to find the label, or create one from the option's text
                let labelText = '';
                if (checkbox.id) {
                    const checkLabel = field.querySelector(`label[for="${checkbox.id}"]`);
                    if (checkLabel) {
                        labelText = checkLabel.textContent.trim();
                    }
                }
                
                // If no label was found, try to get text from the parent element or use a default
                if (!labelText && checkbox.parentElement) {
                    labelText = checkbox.parentElement.textContent.trim().replace(checkbox.outerHTML, '');
                }
                
                // If still no label, use the value or a fallback
                if (!labelText) {
                    labelText = checkbox.value || `Option ${index + 1}`;
                }
                
                checkItem.appendChild(document.createTextNode(' ' + labelText));
                
                // Ensure original checkbox state is synced with the cloned one
                clonedCheckbox.addEventListener('change', function() {
                    checkbox.checked = this.checked;
                });
                
                checkboxGroup.appendChild(checkItem);
            });
            
            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-message';
            
            questionDiv.appendChild(checkboxGroup);
            questionDiv.appendChild(errorMessage);
            stepElement.appendChild(questionDiv);
        } else if (inputElement) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-wrap';

            const questionLabel = document.createElement('div');
            questionLabel.className = 'question-label';
            questionLabel.textContent = labelText;
            questionDiv.appendChild(questionLabel);

            const clonedInput = inputElement.cloneNode(true);
            questionDiv.appendChild(clonedInput);

            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-message';
            questionDiv.appendChild(errorMessage);

            stepElement.appendChild(questionDiv);
        }

        steps.push(stepElement);
        formStepsContainer.appendChild(stepElement);

        const dot = document.createElement('div');
        dot.className = 'step-dot';
        stepIndicator.appendChild(dot);
    });

    if (steps.length === 0) {
        console.error("No form steps were generated.");
        return;
    }

    function showStep(stepIndex) {
        if (stepIndex < 0 || stepIndex >= steps.length) {
            console.error(`Invalid step index: ${stepIndex}`);
            return;
        }

        steps.forEach((step, idx) => {
            step.classList.toggle('active', idx === stepIndex);
            if (stepIndicator.children[idx]) {
                stepIndicator.children[idx].classList.toggle('active', idx === stepIndex);
            }
        });

        progressBar.style.width = `${((stepIndex + 1) / steps.length) * 100}%`;

        prevBtn.style.display = stepIndex === 0 ? 'none' : 'block';
        nextBtn.style.display = stepIndex === steps.length - 1 ? 'none' : 'block';
        finalStepBtn.style.display = stepIndex === steps.length - 1 ? 'block' : 'none';

        const currentInput = steps[stepIndex].querySelector('input:not([type="checkbox"]), select, textarea');
        if (currentInput) {
            setTimeout(() => currentInput.focus(), 300);
        }
    }

    function validateStep() {
        const currentStepEl = steps[currentStep];
        if (!currentStepEl) {
            console.error("Current step element not found.");
            return false;
        }
        
        const inputs = currentStepEl.querySelectorAll('input:not([type="checkbox"]), select, textarea');
        const checkboxGroups = currentStepEl.querySelectorAll('.checkbox-group');
        let isValid = true;
        
        // Validate regular inputs
        inputs.forEach(input => {
            if (!input.required) return;
            
            const errorContainer = input.parentElement.querySelector('.error-message');
            if (input.value.trim() === '') {
                isValid = false;
                input.classList.add('is-invalid');
                if (errorContainer) {
                    errorContainer.textContent = 'This field is required';
                    errorContainer.style.display = 'block';
                }
            } else {
                input.classList.remove('is-invalid');
                if (errorContainer) {
                    errorContainer.style.display = 'none';
                }
            }
        });
        
        // Validate checkbox groups (like skills and languages)
        checkboxGroups.forEach(group => {
            const checkboxes = group.querySelectorAll('input[type="checkbox"]');
            const errorContainer = group.parentElement.querySelector('.error-message');
            
            // Check if this is a required group
            const fieldName = checkboxes[0]?.name.replace(/\[\]/g, '');
            const originalLabel = originalFieldsContainer.querySelector(`label[for^="${fieldName}"]`);
            const isRequired = originalLabel?.textContent.includes('*') || false;
            
            if (isRequired) {
                // Check if at least one checkbox is checked
                let atLeastOneChecked = false;
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) atLeastOneChecked = true;
                });
                
                if (!atLeastOneChecked) {
                    isValid = false;
                    if (errorContainer) {
                        errorContainer.textContent = 'Please select at least one option';
                        errorContainer.style.display = 'block';
                    }
                } else if (errorContainer) {
                    errorContainer.style.display = 'none';
                }
            }
        });
        
        return isValid;
    }

    function showFinalSelectionModal() {
        // Prepare languages section
        const languagesContainer = document.getElementById('languages-container');
        const originalLanguagesContainer = document.getElementById('original-fields').querySelector('#id_languages');
        
        if (originalLanguagesContainer) {
            languagesContainer.innerHTML = originalLanguagesContainer.innerHTML;
        }

        // Show the modal
        finalSelectionModal.style.display = 'block';
        finalSelectionModal.classList.add('show');
    }

    function validateFinalSelection() {
        const selectedLanguages = document.querySelectorAll('input[name="languages"]:checked');
        
        if (selectedLanguages.length === 0) {
            finalSelectionError.textContent = 'Please select at least one language.';
            return false;
        }
        
        finalSelectionError.textContent = '';
        return true;
    }

    nextBtn.addEventListener('click', () => {
        if (validateStep()) {
            currentStep++;
            
            // Check if this is the last regular step
            if (currentStep === steps.length - 1) {
                nextBtn.style.display = 'none';
                finalStepBtn.style.display = 'block';
            }
            
            showStep(currentStep);
        }
    });

    prevBtn.addEventListener('click', () => {
        currentStep--;
        showStep(currentStep);
        
        // Ensure navigation buttons are correct
        nextBtn.style.display = currentStep === steps.length - 1 ? 'none' : 'block';
        finalStepBtn.style.display = currentStep === steps.length - 1 ? 'block' : 'none';
    });

    finalStepBtn.addEventListener('click', () => {
        // Show the final selection modal instead of submitting
        if (validateStep()) {
            showFinalSelectionModal();
        }
    });

    submitFinalFormBtn.addEventListener('click', (e) => {
        e.preventDefault();
        
        if (validateFinalSelection()) {
            // Sync the selected languages to the original form
            const selectedLanguages = document.querySelectorAll('input[name="languages"]:checked');
            const originalLanguagesContainer = document.getElementById('original-fields').querySelector('#id_languages');
            
            // Clear previous selections
            originalLanguagesContainer.querySelectorAll('input').forEach(input => {
                input.checked = false;
            });
            
            // Set new selections
            selectedLanguages.forEach(selectedLang => {
                const originalInput = originalLanguagesContainer.querySelector(`input[value="${selectedLang.value}"]`);
                if (originalInput) {
                    originalInput.checked = true;
                }
            });
            
            // Submit the form
            form.submit();
        }
    });

    closeModalBtn.addEventListener('click', () => {
        finalSelectionModal.style.display = 'none';
        finalSelectionModal.classList.remove('show');
    });

    // Prevent form submission with Enter key
    form.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && currentStep < steps.length - 1) {
            e.preventDefault();
            nextBtn.click();
        }
    });

    // Initial step display
    showStep(currentStep);
});
</script>

{% endblock %}