{% extends 'base.html' %}


{% block navbar %}

    {% if request.user.profile.user_type == 'client' %}

        {% include 'client_navbar.html' %}

    {% else %}

        {{ block.super }}  

    {% endif %}

{% endblock %}

{% block content %}

<div class="chat-fullscreen flex items-center justify-center min-h-screen">
    <div class="relative w-full h-screen">
        <div class="relative bg-white h-full">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">
                    Chat with: 
                    {% if request.user.profile == chat.client %}
                        {{ chat.freelancer.user.username }}
                    {% else %}
                        {{ chat.client.user.username }}
                    {% endif %}
                </h3>
            </div>

            <div id="chat-window" class="chat-window h-[80%] overflow-y-auto p-4">
                {% for message in messages %}
                    <div
                        class="chat-message {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %}"
                    >
                        <div class="message-content-wrapper">
                            <div class="message-content">
                                {{ message.content }}
                            </div>
                            <div class="message-timestamp">{{ message.timestamp|date:"g:i A" }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <form method="POST" class="chat-input-wrapper p-4 border-t">
                {% csrf_token %}
                <textarea
                    name="message"
                    class="chat-input w-full h-20 bg-gray-100 border-none rounded-lg text-md focus:ring-0 focus:outline-none resize-none"
                    placeholder="Type your message..."
                    required
                ></textarea>
                <div class="flex justify-end mt-2">
                    <button
                        type="submit"
                        class="chat-send-button bg-blue-400 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
                    >
                        Send
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>




<script>
    // Get user ID from data attribute
    const currentUserId = parseInt(document.getElementById('chat-container').dataset.userId);
    
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/{{ chat.id }}/'
    );
    const chatWindow = document.getElementById('chat-window');
    const messageInput = document.getElementById('chat-message');
    const sendButton = document.getElementById('send-message');

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', data.user_id === currentUserId ? 'sent' : 'received', 'mb-3');
        
        messageElement.innerHTML = `
            <div class="font-semibold text-sm">${data.username}</div>
            <div class="bg-${data.user_id === currentUserId ? 'blue-100' : 'gray-100'} rounded-lg p-3 inline-block max-w-md">
                ${data.message}
            </div>
            <div class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</div>
        `;
        
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    };

    function sendMessage() {
        const message = messageInput.value;
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    }

    sendButton.onclick = sendMessage;
    messageInput.onkeypress = function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    };

    chatWindow.scrollTop = chatWindow.scrollHeight;
</script>
{% endblock %}